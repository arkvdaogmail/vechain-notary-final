<!DOCTYPE html>
<html>
<head>
    <title>VeChain Notarization (Wallet Version)</title>
    <script src="https://unpkg.com/@vechain/connex@2.1.0/dist/connex.min.js"></script>
</head>
<body>
    <h1>VeChain Document Notarization</h1>
    <p>Please install a VeChain wallet like VeWorld or Sync2 before you begin.</p>
    <hr>
    <input type="file" id="fileInput">
    <button id="notarizeBtn">Notarize with My Wallet</button>
    <div id="result" style="margin-top:20px; font-family:monospace; word-break: break-all;"></div>

    <script>
        document.getElementById('notarizeBtn' ).addEventListener('click', async () => {
            const fileInput = document.getElementById('fileInput');
            const resultDiv = document.getElementById('result');
            const file = fileInput.files[0];
            
            if (!file) {
                resultDiv.innerText = 'Error: Please select a file first.';
                return;
            }

            // Always clear previous results first
            resultDiv.innerHTML = '';

            try {
                // 1. Create the unique fingerprint (hash) of the document
                const fileBuffer = await file.arrayBuffer();
                const hashBuffer = await crypto.subtle.digest('SHA-256', fileBuffer);
                const hash = '0x' + Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');

                // --- THIS IS THE TEST ---
                // Display the hash on the page so we can copy it.
                resultDiv.innerHTML = `Document Hash (for testing): ${hash}`;

                // 2. Now, check for the wallet
                if (!window.connex) {
                    // If no wallet, add the error message but DO NOT throw an error.
                    resultDiv.innerHTML += '  
---  
Error: VeChain wallet not found. (This is OK for our test)';
                    return; // Stop the script here.
                }

                // 3. If a wallet IS found, proceed with the transaction
                resultDiv.innerHTML += '  
---  
Wallet found! Please check your wallet to approve.';
                const signingService = connex.vendor.sign('tx');
                signingService.comment('Notarize document hash');
                
                const { txid } = await signingService.request([{
                    to: null, 
                    value: '0x0',
                    data: hash
                }]);

                // 4. Success! Show the transaction ID
                const explorerUrl = `https://explore-testnet.vechain.org/transactions/${txid}`;
                resultDiv.innerHTML = `âœ… Success! TXID: <a href="${explorerUrl}" target="_blank">${txid}</a>`;

            } catch (error ) {
                // This will catch errors from the wallet (e.g., user rejects transaction)
                console.error(error);
                resultDiv.innerHTML += `  
Error: ${error.message}`;
            }
        });
    </script>
</body>
</html>

